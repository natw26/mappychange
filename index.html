<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MappyChange - Walthamstow</title>

  <!-- Fonts and Leaflet CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <link rel="icon" href="https://mappychange.com/assets/favicon.ico" />

  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#6b7280; --accent:#ffd300; --accent-ink:#1a1a1a; --border:#e5e7eb;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .app{ display:grid; grid-template-rows:auto 1fr; min-height:100%; }
    header{ border-bottom:1px solid var(--border); background:var(--bg); text-align:center; }
    .container{ max-width:1100px; margin:0 auto; padding:12px 16px; }

    /* Brand */
    .brand{ display:flex; align-items:center; justify-content:center; gap:10px; font-family:'Poppins',sans-serif; font-weight:600; font-size:20px; }
    .brand-icon{ width:32px; height:32px; }
    .brand-icon img{ width:100%; height:100%; object-fit:contain; }
    .tagline{ margin:6px 0 0; font-size:14px; color:var(--muted); }
    
    /* Controls */
    .controls{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; align-items:center; justify-content:center; }
        .filter-buttons { display: none; }
    @media (min-width: 1024px) {
      .filter-buttons { display: flex; gap: 8px; }
    }
    /* ADDED: tidy up layout while filters are hidden on sub-desktop */
    @media (max-width: 1023px) {
      .controls{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .stats { text-align: center; }
    }

    .btn{ padding:10px 16px; border-radius:10px; border:1px solid var(--border); background:#fff; color:var(--fg); font-size:14px; cursor:pointer; font-weight:600; transition:all .15s; }
    .btn:hover{ background:#fafafa; transform: translateY(-1px); }
    .btn.active{ background:var(--accent); border-color:var(--accent); color:var(--accent-ink); }
    .btn:focus{ outline:2px solid var(--accent); outline-offset:2px; }
    
    /* Location button - hero action */
    .btn-locate{ 
      background:var(--accent); 
      border:2px solid var(--fg); 
      color:var(--accent-ink); 
      font-size:15px;
      padding:12px 20px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .btn-locate:hover{ 
      transform:translateY(-2px); 
      box-shadow:0 4px 12px rgba(0,0,0,.2); 
    }
    .locate-icon{ width:20px; height:20px; display:flex; align-items:center; justify-content:center; }
    .locate-icon img{ width:100%; height:100%; object-fit:contain; }
    .locate-text{ font-family:'Poppins',sans-serif; }
    
    /* Mobile: make locate button full-width and more prominent */
    @media (max-width: 768px) {
      .controls{ flex-direction:column; align-items:stretch; }
      .btn-locate{ 
        width:100%; 
        justify-content:center; 
        font-size:16px; 
        padding:16px 20px;
        order:-1; /* Always first */
      }
      .btn{ width:100%; justify-content:center; }
      .stats{ width:100%; text-align:center; }
    }

    .stats{ font-size:13px; color:var(--muted); padding:8px 12px; }

    /* Main layout - smaller map for above the fold */
    .main{ position:relative; height:250px; }
    #map{ width:100%; height:100%; background:#f8f9fa; }
    
    @media (min-width: 768px) {
      .main{ height:500px; }
    }
    
    /* Clean up map controls */
    .leaflet-control-zoom{ border:none; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .leaflet-control-zoom a{ width:36px; height:36px; line-height:36px; font-size:20px; border:none; background:#fff; color:var(--fg); }
    .leaflet-control-zoom a:hover{ background:var(--accent); color:var(--accent-ink); }
    .leaflet-bar{ border-radius:10px; overflow:hidden; }
    .leaflet-control-attribution{ background:rgba(255,255,255,0.8); border-radius:6px; padding:2px 6px; font-size:11px; }
    
    /* Pin marker styles */
    .pin-inactive{ opacity:0.4; filter:grayscale(100%); }
    .pin-active{ opacity:1; }
    .leaflet-marker-icon{ 
      filter: drop-shadow(0 0 0 2px #000) drop-shadow(0 2px 4px rgba(0,0,0,0.3)); 
      cursor:pointer;
    }
    .leaflet-marker-icon:hover{
      filter: drop-shadow(0 0 0 3px #000) drop-shadow(0 3px 6px rgba(0,0,0,0.4));
      transform: scale(1.1);
    }

    /* Leaflet popup customization */
    .leaflet-popup-content-wrapper{ border-radius:12px; padding:4px; }
    .leaflet-popup-content{ margin:12px; min-width:220px; font-size:14px; }
    
    .popup-title{ font-family:'Poppins',sans-serif; font-weight:600; font-size:16px; margin:0 0 6px; }
    .popup-category{ display:inline-block; padding:4px 10px; background:var(--accent); color:var(--accent-ink); border-radius:999px; font-size:12px; font-weight:600; margin-bottom:8px; text-transform:capitalize; }
    .popup-info{ font-size:13px; line-height:1.6; color:var(--muted); margin-bottom:10px; }
    .popup-info strong{ color:var(--fg); }
    .badge{ display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; margin-top:6px; }
    .badge.verified{ background:#10b981; color:#fff; }
    .badge.unverified{ background:#f59e0b; color:#fff; }
    .badge.no-change{ background:#ef4444; color:#fff; }
    
    .navigate-btn{
      display:block;
      width:100%;
      padding:10px 16px;
      background:var(--accent);
      border:2px solid var(--fg);
      border-radius:8px;
      color:var(--accent-ink);
      font-weight:600;
      font-size:14px;
      text-align:center;
      text-decoration:none;
      margin-top:10px;
      transition:all .15s;
      font-family:'Poppins',sans-serif;
    }
    .navigate-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    /* Floating action button */
    .fab{ 
      position:absolute; bottom:16px; right:16px; 
      width:56px; height:56px; border-radius:50%; 
      border:2px solid #111; background:var(--accent); 
      color:var(--accent-ink); font-size:28px; 
      display:flex; align-items:center; justify-content:center; 
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.2); 
      transition:transform .15s; z-index:1000; 
      text-decoration:none;
    }
    .fab:hover{ transform:scale(1.05); }
    .fab:focus{ outline:3px solid #000; outline-offset:3px; }

    /* Onboarding Modal */
    .onboarding-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000; padding: 1rem;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(4px);
    }
    .onboarding-overlay.show {
      opacity: 1; pointer-events: all;
    }

    .onboarding-modal {
      background: white; border-radius: 16px;
      max-width: 520px; width: 100%;
      padding: 2.5rem 2rem; position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transform: scale(0.9) translateY(30px);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .onboarding-overlay.show .onboarding-modal {
      transform: scale(1) translateY(0);
    }

    .onboarding-icon {
      text-align: center; margin-bottom: 1rem;
      display: flex; align-items: center; justify-content: center;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .onboarding-title {
      font-family: 'Poppins', sans-serif; font-size: 1.75rem; font-weight: 600;
      color: var(--fg); text-align: center; margin-bottom: 0.5rem;
    }
    .onboarding-subtitle {
      font-size: 1rem; color: var(--fg); text-align: center;
      margin-bottom: 1.5rem; font-weight: 500; line-height: 1.4;
    }
    .onboarding-highlight {
      background: linear-gradient(120deg, var(--accent) 0%, var(--accent) 100%);
      background-size: 100% 40%; background-repeat: no-repeat;
      background-position: 0 85%; padding: 0 4px;
    }

    .onboarding-benefits {
      list-style: none; margin: 1rem 0; padding: 0;
    }
/* Fade-in bullets, 0.8s each, slight stagger */
.onboarding-benefits li {
  padding: 0.65rem 0; font-size: 0.95rem; color: var(--fg);
  display: flex; align-items: flex-start; gap: 0.75rem;
  animation: fadeAppear 0.8s ease forwards;
  opacity: 0; border-bottom: 1px solid var(--border);
}
.onboarding-benefits li:nth-child(1) { animation-delay: 0s; }
.onboarding-benefits li:nth-child(2) { animation-delay: 0.8s; }
.onboarding-benefits li:nth-child(3) { animation-delay: 1.6s; }

@keyframes fadeAppear {
  from { opacity: 0; }
  to   { opacity: 1; }
}

    .onboarding-benefits li::before {
      content: ''; 
      width: 8px; height: 8px; 
      background: var(--accent); 
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 6px;
      border: 2px solid var(--fg);
    }

    .onboarding-cta {
      background: var(--accent); color: var(--accent-ink);
      border: 2px solid var(--fg); padding: 0.9rem 2rem;
      border-radius: 12px; font-size: 1rem; font-weight: 600;
      cursor: pointer; width: 100%; margin-top: 1.5rem;
      transition: all 0.2s; font-family: 'Poppins', sans-serif;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      animation: fadeInButton 0.8s ease forwards;
      animation-delay: 2.4s;
    }
    
    @keyframes fadeInButton {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .onboarding-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .onboarding-skip {
      display: none; /* Removed skip button */
    }

    footer {
      background: #fafafa; padding: 1.5rem;
      text-align: center; color: var(--muted);
      font-size: 0.9rem; border-top: 1px solid var(--border);
    }
    .contribute-btn {
      display: inline-block; margin-top: 0.5rem;
      padding: 0.5rem 1rem; background: var(--accent);
      color: var(--accent-ink); text-decoration: none;
      border-radius: 10px; font-weight: 600;
      border: 1px solid var(--fg); transition: transform 0.2s;
    }
    .contribute-btn:hover { transform: translateY(-2px); }

    @media (max-width: 768px) {
      .onboarding-modal { padding: 1.75rem 1.25rem; max-height:90vh; overflow-y:auto; }
      .onboarding-title { font-size: 1.4rem; margin-bottom:0.4rem; }
      .onboarding-subtitle { font-size: 0.95rem; margin-bottom:1rem; }
      .onboarding-icon { margin-bottom:0.75rem; }
      .onboarding-icon img { width:60px; height:60px; }
      .onboarding-benefits { margin:0.75rem 0; }
      .onboarding-benefits li { padding:0.5rem 0; font-size:0.9rem; gap:0.6rem; }
      .onboarding-cta { padding:0.8rem 1.5rem; font-size:0.95rem; margin-top:1rem; }
      .onboarding-skip { font-size:0.8rem; margin-top:0.5rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingOverlay">
      <div class="onboarding-modal">
        <div class="onboarding-icon"><img src="https://mappychange.com/assets/pin.png" alt="MappyChange" style="width:80px; height:80px; animation: float 3s ease-in-out infinite;"></div>
        <h2 class="onboarding-title">Welcome to MappyChange</h2>
        <p class="onboarding-subtitle">
          <span class="onboarding-highlight">Find baby change facilities</span> in seconds when you're out in Walthamstow
        </p>
        
        <ul class="onboarding-benefits">
          <li>
            <span><strong>📍 Search near you</strong> — tap "Search near my location" and we'll show what's closest</span>
          </li>
          <li>
            <span><strong>🗺️ Navigate instantly</strong> — click any pin and hit "Navigate me there" for Google Maps directions</span>
          </li>
          <li>
            <span><strong>20+ verified spots</strong> across Walthamstow with baby change facilities</span>
          </li>
        </ul>

        <button class="onboarding-cta" onclick="closeOnboarding()">
          Start Exploring
        </button>
      </div>
    </div>

    <header>
      <div class="container">
        <div class="brand">
          <span class="brand-icon"><img src="https://mappychange.com/assets/pin.png" alt="MappyChange logo"></span>
          <span>MappyChange</span>
        </div>
        <p class="tagline">Helping you quickly find a safe, clean place to change your baby while out and about.</p>

        <!-- Filter Controls -->
        <div class="controls">
          <button class="btn btn-locate" id="locateBtn" aria-label="Search near my location">
            <span class="locate-icon"><img src="https://mappychange.com/assets/pin.png" alt=""></span>
            <span class="locate-text">Search near my location</span>
          </button>
          <div class="filter-buttons">
            <button class="btn active" data-filter="all">All</button>
            <button class="btn" data-filter="hospitality">Cafés, Pubs & Restaurants</button>
            <button class="btn" data-filter="shops">Shops</button>
            <button class="btn" data-filter="other">Public loos, Museums & more</button>
          </div>
          <span class="stats" id="stats">Loading...</span>
        </div>
      </div>
    </header>

    <div class="main">
      <div id="map" role="application" aria-label="Map of baby changing places"></div>
      <a href="https://forms.gle/vTJLoicMfhjrpRYv6" target="_blank" rel="noopener noreferrer" class="fab" title="Suggest a place" aria-label="Suggest a place">+</a>
    </div>

    <footer>
      <p><strong>MappyChange</strong> — Built with ❤️ for Walthamstow parents</p>
      <p>Know a spot we're missing? <a href="https://forms.gle/vTJLoicMfhjrpRYv6" target="_blank" rel="noopener noreferrer" class="contribute-btn">Suggest a Location</a></p>
      <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.8;">Updated Oct 2025</p>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Onboarding functionality
    function closeOnboarding() {
      const overlay = document.getElementById('onboardingOverlay');
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
      localStorage.setItem('mappychange_visited', 'true');
    }

    // Show onboarding for first-time visitors
    window.addEventListener('DOMContentLoaded', () => {
      const hasVisited = localStorage.getItem('mappychange_visited');
      if (!hasVisited) {
        setTimeout(() => {
          document.getElementById('onboardingOverlay').classList.add('show');
        }, 600);
      }
    });

    // Close when clicking overlay
    document.getElementById('onboardingOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'onboardingOverlay') {
        closeOnboarding();
      }
    });

    // GeoJSON data - Updated with corrected coordinates
    const facilitiesData = {
      "type": "FeatureCollection",
      "features": [
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0190552, 51.5833762]}, "properties": {"name": "Goose Walthamstow", "category": "pub", "address": "264 Hoe Street", "postcode": "E17 3AX", "baby_change": "yes", "changing_location": "public toilet behind bar", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.017091, 51.590282]}, "properties": {"name": "The Bell Walthamstow", "category": "pub", "address": "617 Forest Road", "postcode": "E17 4NE", "baby_change": "yes", "changing_location": "all-gender loo downstairs", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.05414, 51.58548]}, "properties": {"name": "Walthamstow Wetlands Visitor Centre", "category": "nature reserve", "address": "2 Forest Road", "postcode": "N17 9NH", "baby_change": "yes", "changing_location": "visitor centre toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0130526, 51.5825293]}, "properties": {"name": "Eat17", "category": "restaurant", "address": "28-30 Orford Road", "postcode": "E17 9NJ", "baby_change": "yes", "changing_location": "changing tables in the loos accessible to all genders", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0123562, 51.5825715]}, "properties": {"name": "The Kitchen", "category": "restaurant", "address": "Orford Road", "postcode": "E17 9NJ", "baby_change": "yes", "changing_location": "baby change in the women's toilets", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0236952, 51.5830096]}, "properties": {"name": "17 & Central Shopping Mall", "category": "shopping", "address": "Selborne Walk", "postcode": "E17 7JR", "baby_change": "yes", "changing_location": "brilliant parent & baby room upstairs at CRATE17", "verified": true, "notes": "Private feeding rooms available"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0272078, 51.5827727]}, "properties": {"name": "Sainsbury's Walthamstow", "category": "supermarket", "address": "112 High Street", "postcode": "E17 7JY", "baby_change": "yes", "changing_location": "baby change in the customer toilets", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0284524, 51.57591]}, "properties": {"name": "Walthamstow Leisure Centre", "category": "leisure", "address": "Kirkdale Road", "postcode": "E17 8RN", "baby_change": "yes", "changing_location": "baby change in the changing rooms", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0210573, 51.5842865]}, "properties": {"name": "Walthamstow Library", "category": "library", "address": "High Street", "postcode": "E17 7JN", "baby_change": "yes", "changing_location": "baby change in the accessible toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0202753, 51.5912847]}, "properties": {"name": "William Morris Gallery", "category": "museum", "address": "Lloyd Park", "postcode": "E17 4PP", "baby_change": "yes", "changing_location": "baby change in the gallery toilets", "verified": true, "notes": "Open during gallery hours"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0349865, 51.576929]}, "properties": {"name": "Walthamstow Pumphouse Museum", "category": "museum", "address": "South Access Road", "postcode": "E17 8AX", "baby_change": "yes", "changing_location": "baby change in the toilets", "verified": true, "notes": "Open 2nd & 4th Sunday"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0211477, 51.5936683]}, "properties": {"name": "Lloyd Park Centre", "category": "park", "address": "Forest Road", "postcode": "E17 4PP", "baby_change": "yes", "changing_location": "baby change in the centre toilets", "verified": true, "notes": "Only open Sunday and Monday"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0215039, 51.5877721]}, "properties": {"name": "Greenleaf Road Baptist Church", "category": "church", "address": "4 Greenleaf Road", "postcode": "E17 6QQ", "baby_change": "yes", "changing_location": "accessible toilet and baby changing area", "verified": false, "notes": "Community Living Room - Mon 10:30am-2pm"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0159046, 51.6033181]}, "properties": {"name": "Walthamstow Stadium (Better Gym)", "category": "gym", "address": "Chingford Road", "postcode": "E4 8SJ", "baby_change": "yes", "changing_location": "baby change in the accessible toilets", "verified": false, "notes": "Community Hub - Thu 12pm-3pm"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0021673, 51.5750834]}, "properties": {"name": "The Cornerstone", "category": "community", "address": "149 Canterbury Road", "postcode": "E10 6EH", "baby_change": "yes", "changing_location": "community facilities", "verified": false, "notes": "Parent & baby drop-in Thu 10:30am-12pm"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0209357, 51.5906977]}, "properties": {"name": "Walthamstow Salvation Army", "category": "community", "address": "434 Forest Road", "postcode": "E17 4PY", "baby_change": "yes", "changing_location": "in The Meeting Place facilities", "verified": false, "notes": "The Meeting Place - has play space"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0345755, 51.5813353]}, "properties": {"name": "The Mill", "category": "community", "address": "7-11 Coppermill Lane", "postcode": "E17 7HA", "baby_change": "yes", "changing_location": "baby change in the accessible toilets", "verified": true, "notes": "Children's playroom for under 5s"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0269353, 51.5936782]}, "properties": {"name": "Priory Court Community Centre", "category": "community", "address": "11 Priory Court", "postcode": "E17 5NB", "baby_change": "yes", "changing_location": "baby change in the accessible toilet", "verified": false, "notes": "Closed at the weekend"}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0325923, 51.5805997]}, "properties": {"name": "Crate St James", "category": "cafe", "address": "35 St James Street", "postcode": "E17 7FY", "baby_change": "yes", "changing_location": "baby changing in the loos", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0160095, 51.5900271]}, "properties": {"name": "Enjoy Café", "category": "cafe", "address": "623 Forest Road", "postcode": "E17 4NA", "baby_change": "yes", "changing_location": "baby change in café toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0208127, 51.5880706]}, "properties": {"name": "Le Delice Restaurant", "category": "restaurant", "address": "114 Hoe Street", "postcode": "E17 4QR", "baby_change": "yes", "changing_location": "baby change in restaurant toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.019075, 51.5835931]}, "properties": {"name": "McDonald's - Walthamstow", "category": "fast food", "address": "258-260 Hoe Street", "postcode": "E17 3AX", "baby_change": "yes", "changing_location": "baby change in customer toilets", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0037225, 51.5871666]}, "properties": {"name": "Wood Street Library", "category": "public building", "address": "1 Troubridge Square", "postcode": "E17 3HB", "baby_change": "yes", "changing_location": "baby change in library toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0403076, 51.587401]}, "properties": {"name": "Yasar Kebab & Steak's", "category": "restaurant", "address": "8 Blackhorse Lane", "postcode": "E17 6HJ", "baby_change": "yes", "changing_location": "baby change in restaurant toilets", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0151643460340, 51.5978041806726]}, "properties": {"name": "Dog and Duck", "category": "pub", "address": "222 Chingford Rd, London", "postcode": "E17 5AL", "baby_change": "yes", "changing_location": "baby change in the wine toilet", "verified": false}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.002418, 51.5861297973845]}, "properties": {"name": "Lancaster Home & Garden", "category": "shop", "address": "Unit 2, 186 Wood Rd", "postcode": "E17 3NZ", "baby_change": "yes", "changing_location": "1 unisex toilet with baby changing facilities", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0112269802940319, 51.5807038388545]}, "properties": {"name": "The Castle", "category": "pub", "address": "15 Grosvenor Rise E, London", "postcode": "E17 9LB", "baby_change": "yes", "changing_location": "baby change in female toilets", "verified": true}},
        {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-0.0135789564725148, 51.5823733052739]}, "properties": {"name": "Queens Arms", "category": "pub", "address": "42 Orford Rd, London", "postcode": "E17 9NJ", "baby_change": "yes", "changing_location": "baby change in the female toilet (very tight squeeze)", "verified": true}}
      ]
    };

    // Initialize map with modern, clean style
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([51.5860, -0.0220], 14);
    
    // Modern, minimal map style (CartoDB Positron - clean and simple)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '© OpenStreetMap, © CartoDB',
      maxZoom: 19,
      subdomains: 'abcd'
    }).addTo(map);

    let markers = [];
    let currentFilter = 'all';
    let userLocation = null;

    // Category mapping
    const categoryGroups = {
      'hospitality': ['cafe', 'restaurant', 'pub'],
      'shops': ['shopping', 'supermarket'],
      'other': ['library', 'museum', 'park', 'leisure', 'entertainment', 'public_toilet', 'nature reserve', 'transport']
    };

    // Location button functionality
    document.getElementById('locateBtn').addEventListener('click', () => {
      const btn = document.getElementById('locateBtn');
      const originalHTML = btn.innerHTML;
      
      btn.innerHTML = '<span class="locate-icon">⌛</span><span class="locate-text">Finding you...</span>';
      btn.disabled = true;

      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = [position.coords.latitude, position.coords.longitude];
            map.setView(userLocation, 16);
            
            // Add user location marker
            L.circleMarker(userLocation, {
              radius: 10,
              fillColor: '#4A90E2',
              fillOpacity: 0.8,
              color: '#fff',
              weight: 3
            }).addTo(map).bindPopup('You are here');
            
            btn.innerHTML = '<span class="locate-icon"><img src="https://mappychange.com/assets/pin.png" alt=""></span><span class="locate-text">Showing nearby ✓</span>';
            btn.style.background = '#10b981';
            btn.style.borderColor = '#10b981';
            btn.style.color = '#fff';
            
            setTimeout(() => {
              btn.innerHTML = originalHTML;
              btn.disabled = false;
              btn.style.background = 'var(--accent)';
              btn.style.borderColor = 'var(--fg)';
              btn.style.color = 'var(--accent-ink)';
            }, 20000);
          },
          (error) => {
            btn.innerHTML = '<span class="locate-icon">⚠️</span><span class="locate-text">Location unavailable</span>';
            setTimeout(() => {
              btn.innerHTML = originalHTML;
              btn.disabled = false;
            }, 2000);
            console.error('Geolocation error:', error);
          }
        );
      } else {
        btn.innerHTML = '<span class="locate-icon">⚠️</span><span class="locate-text">Not supported</span>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }, 2000);
      }
    });

    // Custom pin icon - using MappyChange pin.png
    function createIcon(hasChange) {
      const opacity = hasChange === 'yes' ? '1' : '0.4';
      return L.icon({
        iconUrl: 'https://mappychange.com/assets/pin.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32],
        className: hasChange === 'yes' ? 'pin-active' : 'pin-inactive'
      });
    }

    function createPopupContent(props) {
      // Create Google Maps directions URL
      const destination = encodeURIComponent(`${props.name}, ${props.address}, ${props.postcode}`);
      const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;

      let badge = '';
      if (props.baby_change === 'no') {
        badge = '<span class="badge no-change">No baby change</span>';
      } else if (props.verified) {
        badge = '<span class="badge verified">Verified ✓</span>';
      } else {
        badge = '<span class="badge unverified">Needs verification</span>';
      }

      return `
        <div class="popup-title">${props.name}</div>
        <span class="popup-category">${props.category}</span>
        <div class="popup-info">
          <strong>Address:</strong> ${props.address}<br>
          <strong>Postcode:</strong> ${props.postcode}<br>
          ${props.baby_change === 'yes' ? `<strong>Location:</strong> ${props.changing_location}<br>` : ''}
          ${props.notes ? `<em style="font-size:12px;">${props.notes}</em>` : ''}
        </div>
        ${badge}
        <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="navigate-btn">
          🗺️ Navigate me there
        </a>
      `;
    }

    function addMarkers(filter = 'all') {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      let count = 0;
      let withChange = 0;

      facilitiesData.features.forEach(feature => {
        const props = feature.properties;
        let shouldShow = false;

        if (filter === 'all') {
          shouldShow = true;
        } else if (categoryGroups[filter]) {
          shouldShow = categoryGroups[filter].includes(props.category);
        } else {
          shouldShow = props.category === filter;
        }
        
        if (shouldShow) {
          const [lng, lat] = feature.geometry.coordinates;
          const marker = L.marker([lat, lng], {
            icon: createIcon(props.baby_change)
          }).addTo(map);
          
          marker.bindPopup(createPopupContent(props), {
            maxWidth: 300,
            className: 'custom-popup'
          });
          markers.push(marker);
          count++;
          if (props.baby_change === 'yes') withChange++;
        }
      });

      document.getElementById('stats').textContent = 
        `${count} location${count !== 1 ? 's' : ''} • ${withChange} with baby change`;
    }

    // Filter functionality
    document.querySelector('.controls').addEventListener('click', (e) => {
      if (e.target.classList.contains('btn') && e.target.dataset.filter && !e.target.id) {
        document.querySelectorAll('.btn[data-filter]').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        addMarkers(currentFilter);
      }
    });

    addMarkers();
  </script>
</body>
</html>
