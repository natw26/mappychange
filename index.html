<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>mappychange ¬∑ Walthamstow map</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root {
      --bg:#ffffff; --text:#0f172a; --muted:#475569; --brand:#111827; --accent:#0ea5e9;
      --chip:#eef2f7; --chipText:#0f172a; --border:#e5e7eb;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg); }
    header { position:sticky; top:0; z-index:5; background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border); }
    .wrap { max-width:1200px; margin:0 auto; padding:12px 16px; }
    .bar { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .brand { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .logo { width:28px; height:28px; border-radius:8px; background:var(--accent); display:grid; place-items:center; color:white; font-weight:700; }
    h1 { font-size:16px; margin:0; }
    .controls { display:grid; grid-template-columns: 1fr auto auto; gap:8px; }
    input, button { padding:12px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; color:var(--text); }
    input::placeholder { color:#94a3b8; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); font-weight:600; cursor:pointer; }
    button.ghost { background:#fff; border:1px solid var(--border); cursor:pointer; }
    .app { display:grid; grid-template-columns: 400px 1fr; min-height: calc(100vh - 84px); }
    #sidebar { border-right:1px solid var(--border); background:#fff; display:flex; flex-direction:column; }
    #list { overflow:auto; padding:8px 8px 16px; display:grid; gap:8px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px; display:grid; gap:8px; }
    .title { font-size:15px; font-weight:700; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .sub { font-size:13px; color:var(--muted); }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { font-size:12px; padding:4px 10px; border-radius:999px; background:var(--chip); color:var(--chipText); border:1px solid var(--border); }
    .chip.distance { background:#f0f9ff; border-color:#bae6fd; color:#0369a1; }
    #map { width:100%; height:100%; }
    .footer { padding:12px 16px; border-top:1px solid var(--border); color:var(--muted); font-size:12px; }
    .hint { font-size:12px; color:var(--muted); }
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      #sidebar { height: 48vh; }
      #map { height: 52vh; }
      .controls { grid-template-columns: 1fr auto; }
    }
    .ml-popup { font: 12px/1.4 system-ui, sans-serif; color:#111; }
    .ml-popup .name { font-weight:700; margin-bottom:4px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .divider { height:1px; background:var(--border); margin:8px 0; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">üçº</div>
        <h1>mappychange</h1>
      </div>
      <!-- Prominent location controls -->
      <div class="controls">
        <input id="postcode" type="text" placeholder="Enter postcode or town (eg E17 4JF or Walthamstow)" />
        <button id="goto" class="ghost">Go</button>
        <button id="locate" class="primary">Use my location</button>
      </div>
      <div class="hint" style="margin-top:8px">You can also type a venue name in the search below.</div>
    </div>
  </header>

  <div class="app">
    <aside id="sidebar">
      <div class="wrap" style="padding:12px 12px 0 12px;">
        <input id="q" type="search" placeholder="Search venue name or postcode" />
      </div>
      <div id="list"></div>
      <div class="footer">
        Data last updated: <span id="lastUpdated">loading‚Ä¶</span>. No photos, no logins.
      </div>
    </aside>
    <main id="map"></main>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script>
    // ====== CONFIG ======
    const MAPTILER_KEY = "zouFxW02vyhPO2yBO8SN"; // your key inserted
    const GEOJSON_URL = "./mappychange_walthamstow.geojson"; // adjust if you move the file
    // Trendier light style
    const MAP_STYLE = `https://api.maptiler.com/maps/dataviz/style.json?key=${MAPTILER_KEY}`;
    const DEFAULT_BOUNDS = [[-0.062, 51.56],[0.02, 51.61]];
    const FORM_URL = "https://docs.google.com/forms/d/e/REPLACE/viewform";

    // ====== STATE ======
    let allFeatures = [];
    let userPos = null;
    let filtered = [];

    // ====== MAP ======
    const map = new maplibregl.Map({
      container: 'map',
      style: MAP_STYLE,
      bounds: DEFAULT_BOUNDS,
      fitBoundsOptions: { padding: 40 },
      attributionControl: true
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    const geolocate = new maplibregl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: false });
    map.addControl(geolocate, 'top-right');

    // Load data
    fetch(GEOJSON_URL).then(r=>r.json()).then(data => {
      allFeatures = data.features;
      const dates = allFeatures.map(f => (f.properties && f.properties.last_checked) || '').filter(Boolean);
      document.getElementById('lastUpdated').textContent = dates.length ? dates.sort().slice(-1)[0] : 'unknown';

      map.on('load', () => {
        map.addSource('places', { type: 'geojson', data, cluster: true, clusterMaxZoom: 14, clusterRadius: 50 });
        // Softer monochrome markers
        map.addLayer({ id:'clusters', type:'circle', source:'places', filter:['has','point_count'],
          paint:{ 'circle-color':'#111827', 'circle-radius':['step',['get','point_count'],12, 15,16, 30,22], 'circle-opacity':0.8 }});
        map.addLayer({ id:'cluster-count', type:'symbol', source:'places', filter:['has','point_count'],
          layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 }, paint:{ 'text-color':'#ffffff' }});
        map.addLayer({ id:'unclustered', type:'circle', source:'places', filter:['!',['has','point_count']],
          paint:{ 'circle-color':'#111827', 'circle-radius':6, 'circle-stroke-width':1.2, 'circle-stroke-color':'#ffffff' }});

        // Filtered source without clustering
        map.addSource('filtered', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
        map.addLayer({ id:'filtered-points', type:'circle', source:'filtered',
          paint:{ 'circle-color':'#0ea5e9', 'circle-radius':7, 'circle-stroke-width':1.2, 'circle-stroke-color':'#111827' },
          layout:{ 'visibility':'none' }});

        // Popups
        map.on('click', 'unclustered', (e) => showPopup(e.features[0]));
        map.on('click', 'filtered-points', (e) => showPopup(e.features[0]));

        map.on('click', 'clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
          const clusterId = features[0].properties.cluster_id;
          const source = map.getSource('places');
          source.getClusterExpansionZoom(clusterId, (err, zoom) => {
            if (err) return;
            map.easeTo({ center: features[0].geometry.coordinates, zoom });
          });
        });

        map.on('mouseenter', 'unclustered', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'unclustered', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'filtered-points', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'filtered-points', () => map.getCanvas().style.cursor = '');
      });

      runFilter();
    }).catch(err => {
      console.error('Failed to load GeoJSON', err);
      alert('Could not load the map data. Make sure the GeoJSON path is correct.');
    });

    // ====== UI HOOKS ======
    const $q = document.getElementById('q');
    const $pc = document.getElementById('postcode');
    const $goto = document.getElementById('goto');
    const $list = document.getElementById('list');
    document.getElementById('locate').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Location is not available on this device');
      navigator.geolocation.getCurrentPosition(pos => {
        userPos = [pos.coords.longitude, pos.coords.latitude];
        map.easeTo({ center: userPos, zoom: 14 });
        runFilter();
      }, () => alert('Could not get your location'));
    });
    $goto.addEventListener('click', gotoPostcode);
    $pc.addEventListener('keydown', (e)=>{ if(e.key==='Enter') gotoPostcode(); });
    $q.addEventListener('input', runFilter);

    async function gotoPostcode() {
      const q = $pc.value.trim();
      if (!q) return;
      try {
        const url = `https://api.maptiler.com/geocoding/${encodeURIComponent(q)}.json?key=${MAPTILER_KEY}&country=gb&limit=1`;
        const res = await fetch(url);
        const data = await res.json();
        const f = data.features && data.features[0];
        if (!f) return alert('Could not find that place');
        const [lon, lat] = f.center || f.geometry.coordinates;
        map.easeTo({ center: [lon, lat], zoom: 15, duration: 600 });
      } catch(e) {
        alert('Search failed');
      }
    }

    // ====== RENDER ======
    function runFilter() {
      const q = $q.value.trim().toLowerCase();
      const items = allFeatures.filter(f => {
        if (!q) return true;
        const p = f.properties || {};
        const hay = `${p.name||''} ${p.address||''} ${p.postcode||''}`.toLowerCase();
        return hay.includes(q);
      });
      if (map.getSource('filtered')) {
        map.getSource('filtered').setData({ type:'FeatureCollection', features: q ? items : [] });
        map.setLayoutProperty('filtered-points','visibility', q ? 'visible' : 'none');
        map.setLayoutProperty('clusters','visibility', q ? 'none' : 'visible');
        map.setLayoutProperty('cluster-count','visibility', q ? 'none' : 'visible');
        map.setLayoutProperty('unclustered','visibility', q ? 'none' : 'visible');
      }
      renderList(q ? items : allFeatures);
    }

    function renderList(items) {
      const sorted = (userPos)
        ? items.slice().sort((a,b)=>dist(userPos,a.geometry.coordinates)-dist(userPos,b.geometry.coordinates))
        : items.slice().sort((a,b)=>(a.properties.name||'').localeCompare(b.properties.name||''));
      $list.innerHTML = '';
      sorted.forEach(f => {
        const p = f.properties || {};
        const d = userPos ? `${(dist(userPos, f.geometry.coordinates)).toFixed(2)} km` : '';
        const toiletType = humanToiletType(p.changing_location);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="title"><span>${esc(p.name)}</span>${d?`<span class="chip distance">${d}</span>`:''}</div>
          <div class="sub">${esc(p.address||'')}${p.postcode?', '+esc(p.postcode):''}</div>
          <div class="chips">
            ${toiletType? `<span class="chip">Toilet type: ${esc(toiletType)}</span>`:''}
            ${p.baby_change? `<span class="chip">Baby change: ${esc(p.baby_change)}</span>`:''}
            ${p.cleanliness_rating? `<span class="chip">Cleanliness ${esc(p.cleanliness_rating)}/5</span>`:''}
          </div>`;
        card.addEventListener('click', () => {
          map.easeTo({ center: f.geometry.coordinates, zoom: 16 });
          showPopup(f);
        });
        $list.appendChild(card);
      });
    }

    function humanToiletType(raw) {
      const s = String(raw||'').toLowerCase();
      if (!s) return '';
      if (s.includes('unisex')) return 'Unisex';
      if (s.includes('men')) return 'Men‚Äôs';
      if (s.includes('women') || s.includes('female')) return 'Women‚Äôs';
      if (s.includes('accessible')) return 'Unisex'; // treat accessible as unisex for display
      if (s.includes('dedicated')) return 'Unisex'; // parent room is effectively unisex
      return 'Unknown';
    }

    function showPopup(f) {
      const p = f.properties || {};
      const hasUser = !!userPos;
      const d = hasUser ? (dist(userPos, f.geometry.coordinates)).toFixed(2)+' km' : '';
      const toiletType = humanToiletType(p.changing_location);
      const html = `
        <div class="ml-popup">
          <div class="name">${esc(p.name)} ${hasUser ? `<span class="chip distance">${d}</span>`:''}</div>
          <div>${esc(p.address || '')} ${esc(p.postcode || '')}</div>
          <div class="divider"></div>
          <div><strong>Toilet type:</strong> ${esc(toiletType || 'Unknown')}</div>
          <div><strong>Baby change:</strong> ${esc(p.baby_change || 'Unknown')}</div>
          ${p.cleanliness_rating ? `<div><strong>Cleanliness:</strong> ${esc(p.cleanliness_rating)}/5</div>`:''}
          ${p.opening_hours_notes ? `<div class="small">${esc(p.opening_hours_notes)}</div>`:''}
          ${p.verification_status ? `<div class="small">Status: ${esc(p.verification_status)}</div>`:''}
        </div>`;
      new maplibregl.Popup({ closeOnClick: true, offset: 10 })
        .setLngLat(f.geometry.coordinates)
        .setHTML(html)
        .addTo(map);
    }

    // ====== UTILS ======
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function dist(a, b){ // km
      const [lon1, lat1] = a; const [lon2, lat2] = b;
      const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
      const x = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }
  </script>
</body>
</html>
