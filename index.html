<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MappyChange</title>
  <link href="https://api.maptiler.com/maps/streets-v2/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
  <style>
    body {
      margin: 0; 
      font-family: "Poppins", sans-serif; 
      display: flex; 
      flex-direction: column; 
      height: 100vh;
    }
    header {
      text-align: center;
      padding: 8px;
    }
    #map {
      flex: 1;
      min-height: 360px;
      border-top: 1px solid #ddd;
    }
    .search-bar {
      display: flex;
      gap: 8px;
      padding: 10px;
      justify-content: center;
    }
    .search-bar input {
      flex: 1;
      padding: 8px;
      font-size: 16px;
    }
    .search-bar button {
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
    }
    .results-list {
      margin: 12px;
    }
    .result-card {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result-card:hover {
      background: #f9f9f9;
    }
    .fab {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid #111;
      background: #FFD300;
      color: #111;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>MappyChange</h1>
    <p>Quickly find safe, clean places to change your baby while out and about.</p>
  </header>

  <div class="search-bar">
    <input type="text" id="search" placeholder="Search by name, postcode or category">
    <button id="searchBtn">Search</button>
    <button id="locate">Use My Location</button>
  </div>

  <div id="results" class="results-list"></div>
  <div id="map"></div>
  <div id="fab-suggest" class="fab">+</div>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    const MAPTILER_KEY = "zouFxW02vyhPO2yBO8SN";
    const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;
    const GEOJSON_URL = "/data/mappychange_walthamstow.geojson";
    const FORM_URL = "https://forms.gle/VUFTbD6G8dLh2DrD7";
    const DEFAULT_BOUNDS = [[-0.064, 51.556],[0.028, 51.615]];
    const MARKER_ICON = '/assets/pin.png';

    const map = new maplibregl.Map({ container:'map', style:STYLE_URL, bounds:DEFAULT_BOUNDS });
    map.addControl(new maplibregl.NavigationControl());

    async function fetchGeoJSON(){
      const res = await fetch(GEOJSON_URL, { cache: 'no-store' });
      return await res.json();
    }

    function getDistance(c1, c2){
      const dx = c1[0] - c2[0];
      const dy = c1[1] - c2[1];
      return Math.sqrt(dx*dx + dy*dy);
    }

    document.getElementById('locate').addEventListener('click', ()=>{
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const {latitude, longitude} = pos.coords;
          map.flyTo({center:[longitude, latitude], zoom:14});
        });
      }
    });

    document.getElementById('fab-suggest').addEventListener('click', ()=> window.open(FORM_URL, '_blank'));

    map.on('load', async () => {
      const data = await fetchGeoJSON();
      map.addSource('places', { type:'geojson', data });
      map.loadImage(MARKER_ICON, (error, image) => {
        if (!error && image){
          map.addImage('custom-pin', image);
          map.addLayer({ id:'places-layer', type:'symbol', source:'places', layout:{ 'icon-image':'custom-pin','icon-size':0.06,'icon-allow-overlap':true }});
        }
      });
    });

    // âœ… Search function
    const searchInput = document.getElementById("search");
    const searchBtn = document.getElementById("searchBtn");
    const resultsDiv = document.getElementById("results");

    function runSearch() {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) return;

      fetch(GEOJSON_URL)
        .then(res => res.json())
        .then(data => {
          const matches = data.features.filter(f => {
            const { name, address, category } = f.properties;
            return (
              (name && name.toLowerCase().includes(query)) ||
              (address && address.toLowerCase().includes(query)) ||
              (category && category.toLowerCase().includes(query))
            );
          });

          if (matches.length) {
            const mapCenter = map.getCenter().toArray();
            matches.sort((a, b) =>
              getDistance(mapCenter, a.geometry.coordinates) -
              getDistance(mapCenter, b.geometry.coordinates)
            );
            const top5 = matches.slice(0, 5);

            resultsDiv.innerHTML = "";
            top5.forEach(match => {
              const { name, address, category } = match.properties;
              const coords = match.geometry.coordinates;

              const card = document.createElement("div");
              card.className = "result-card";
              card.innerHTML = `<strong>${name}</strong><br>${address || ""}<br><em>${category || ""}</em>`;
              card.addEventListener("click", () => {
                map.flyTo({ center: coords, zoom: 16 });
                new maplibregl.Popup()
                  .setLngLat(coords)
                  .setHTML(`<strong>${name}</strong><br>${address || ""}<br><em>${category || ""}</em>`)
                  .addTo(map);
              });
              resultsDiv.appendChild(card);
            });
          } else {
            resultsDiv.innerHTML = "<p>No results found.</p>";
          }
        });
    }

    searchBtn.addEventListener("click", runSearch);
    searchInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
  </script>
</body>
</html>


