<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MappyChange</title>
  <link href="https://api.maptiler.com/maps/streets-v2/style.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"/>
  <link rel="stylesheet" href="assets/style.css"/>
  <link rel="icon" href="assets/pin.png" type="image/png"/>

  <style>
    /* Results list styling */
    .results-list {
      max-height: 240px;
      overflow-y: auto;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .result-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .result-card:hover {
      background: #f9f9f9;
    }
    .result-card strong {
      display: block;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1><img src="assets/logo.png" alt="MappyChange" style="height:32px; vertical-align:middle; margin-right:8px;"> MappyChange</h1>
    <p style="text-align:center; font-size:14px;">Quickly find a safe, clean place to change your baby while out and about</p>
    <div style="display:flex; flex-direction:column; gap:8px; max-width:320px; margin:0 auto;">
      <input type="text" id="search" placeholder="Search by name, address or category" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
      <button id="locate" style="padding:8px; border:1px solid #111; border-radius:4px; background:#FFD300; cursor:pointer;">Use my location</button>
      <!-- ✅ Results container -->
      <div id="results" class="results-list"></div>
    </div>
  </header>

  <main>
    <div id="map" style="width:100%; height:500px;"></div>
    <div id="fab-suggest" class="fab">+</div>
  </main>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    const MAPTILER_KEY = "zouFxW02vyhPO2yBO8SN";
    const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;
    const GEOJSON_URL = "/data/mappychange_walthamstow.geojson";
    const FORM_URL = "https://forms.gle/VUFTbD6G8dLh2DrD7";
    const DEFAULT_BOUNDS = [[-0.064, 51.556],[0.028, 51.615]];
    const MARKER_ICON = '/assets/pin.png';

    const map = new maplibregl.Map({ container:'map', style:STYLE_URL, bounds:DEFAULT_BOUNDS });
    map.addControl(new maplibregl.NavigationControl());

    async function fetchGeoJSON(){
      const res = await fetch(GEOJSON_URL, { cache: 'no-store' });
      return await res.json();
    }

    document.getElementById('locate').addEventListener('click', ()=>{
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const {latitude, longitude} = pos.coords;
          map.flyTo({center:[longitude, latitude], zoom:14});
        });
      }
    });

    document.getElementById('fab-suggest').addEventListener('click', ()=> window.open(FORM_URL, '_blank'));

    map.on('load', async () => {
      const data = await fetchGeoJSON();

      map.addSource('places', { type:'geojson', data });
      map.loadImage(MARKER_ICON, (error, image) => {
        if (!error && image){
          if (!map.hasImage('custom-pin')) map.addImage('custom-pin', image);
          map.addLayer({ id:'unclustered', type:'symbol', source:'places', layout:{ 'icon-image':'custom-pin','icon-size':0.06,'icon-allow-overlap':true } });
        }
      });

      // ✅ Popup on marker click
      map.on('click','unclustered',(e)=>{
        const coords = e.features[0].geometry.coordinates.slice();
        const { name, address, category } = e.features[0].properties;
        new maplibregl.Popup()
          .setLngLat(coords)
          .setHTML(`<strong>${name}</strong><br>${address}<br><em>${category}</em>`)
          .addTo(map);
      });
    });

    // ✅ Distance helper
    function getDistance(coord1, coord2) {
      const [lon1, lat1] = coord1;
      const [lon2, lat2] = coord2;
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // ✅ Search with cards
    const searchInput = document.getElementById("search");
    const resultsDiv = document.getElementById("results");

    if (searchInput) {
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const query = searchInput.value.trim().toLowerCase();
          if (!query) return;

          fetch(GEOJSON_URL)
            .then((res) => res.json())
            .then((data) => {
              const matches = data.features.filter((f) => {
                const { name, address, category } = f.properties;
                return (
                  (name && name.toLowerCase().includes(query)) ||
                  (address && address.toLowerCase().includes(query)) ||
                  (category && category.toLowerCase().includes(query))
                );
              });

              if (matches.length) {
                const mapCenter = map.getCenter().toArray();
                matches.sort((a, b) =>
                  getDistance(mapCenter, a.geometry.coordinates) -
                  getDistance(mapCenter, b.geometry.coordinates)
                );

                const top5 = matches.slice(0, 5);

                resultsDiv.innerHTML = "";
                top5.forEach((match) => {
                  const { name, address, category } = match.properties;
                  const coords = match.geometry.coordinates;

                  const card = document.createElement("div");
                  card.className = "result-card";
                  card.innerHTML = `<strong>${name}</strong>${address || ""}<br><em>${category || ""}</em>`;
                  card.addEventListener("click", () => {
                    map.flyTo({ center: coords, zoom: 16 });
                    new maplibregl.Popup()
                      .setLngLat(coords)
                      .setHTML(`<strong>${name}</strong><br>${address || ""}<br><em>${category || ""}</em>`)
                      .addTo(map);
                  });

                  resultsDiv.appendChild(card);
                });
              } else {
                resultsDiv.innerHTML = "<p>No results found.</p>";
              }
            });
        }
      });
    }
  </script>
</body>
</html>

